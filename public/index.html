<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width= device-width, initial-scale=1.0">
    <title>CL2 Tareas</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/superhero/bootstrap.min.css" integrity="undefined" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />

    <link rel="stylesheet" type="text/css" href="../css/estilos.css">

</head>

<body>

    <!-- AQUI EMPIEZA LA NAVEGACION -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <p class="navbar-brand" href="#">Tareas Pablito</p>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon">                    
                </span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-toggle="modal" id="linkSignIn"  data-target="#ingresarModal">Sign In</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-toggle="modal"  id="linkSignUp" data-target="#registrarseModal">Sign Up</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <!-- Modal  REGISTRARSE-->
    <div class="modal fade" id="registrarseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Registrate</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="registrarse-form">
            <div class="form-group">
                <input type="text" id="registrarse-nombre" class="form-control" placeholder="Nombres" required>
              </div>
              <div class="form-group">
                  <input type="text" id="registrarse-email" class="form-control" placeholder="Correo" required>
              </div>
              <div class="form-group">
                  <input type="password" id="registrarse-password" class="form-control" placeholder="Contraseña" required>
              </div>
            <button type="submit" class="btn btn-success btn-block">Registrarse</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL INGRESAR-->
  <div class="modal fade" id="ingresarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Logueate</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="ingresar-form">
            <div class="form-group">
                <input type="text" id="ingresar-email" class="form-control" placeholder="Correo" required>
            </div>
            <div class="form-group">
                <input type="password" id="ingresar-password" class="form-control" placeholder="Contraseña" required>
            </div>
            <button type="submit" class="btn btn-secondary btn-block">Ingresar</button>
            <button type="button" id="googleSignIn" class="btn btn-info btn-block">Ingresar con Google</button>
            <button type="button" id="facebookSignIn" class="btn btn-primary btn-block">Ingresar con Facebook</button>
            <button type="button" id="twitterSignIn" class="btn btn-dark btn-block">Ingresar con Twitter</button>
          </form>
        </div>
    
      </div>
    </div>
  </div>


  
  <!-- AÑADIR TAREA -->
  <div class="container p-4">
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">

            <h1 class="h4">Añade una tarea</h1>

            <form id="task-form">
              <div class="form-group">
                <input type="text" id="task-titulo" class="form-control" class="Task Title" placeholder="Título" autofocus required>
              </div>
              <div class="form-group">
                <textarea id="task-descripcion" rows="3" class="form-control" placeholder="Descripción" required></textarea>
              </div>
              <div class="form-group">
                <label>Imagen referencial (opcional)</label>
                <input id="task-imagen" type="file" class="form-control-file" placeholder="Imagen recordatorio"></input>
              </div>

              <div class="form-group">
                <label>Suba un archivo pdf, xcl ... etc (opcional)</label>
                <input id="task-archivo" type="file" class="form-control-file" placeholder="Archivo recordatorio"></input>
              </div>
              <div style="text-align: center;">
                <button class="btn btn-primary btn-block" id="btn-task-form">Guardar</button>
              </div>
              
            </form>
          </div>
        </div>
      </div>
      <!-- LISTA DE LAS TAREAS -->
      <div class="col-md-6" id="tasks-contenedor"></div>
    </div>
  </div>

  <!-- SCRIPS PARA LOS MODALS Y DEMAS FUNCIONES-->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>

<!-- Compiled and minified JavaScript -->
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-analytics.js"></script>


<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-auth.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-firestore.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-storage.js"></script>


<script>
    var firebaseConfig = {
    apiKey: "AIzaSyBYE9dkzokTxT7WH-hzet2epiF4eHbvnzs",
    authDomain: "cl2dswiiurbano.firebaseapp.com",
    projectId: "cl2dswiiurbano",
    storageBucket: "cl2dswiiurbano.appspot.com",
    messagingSenderId: "1054201030969",
    appId: "1:1054201030969:web:e9ccf5ad3ea7c80784e0e8",
    measurementId: "G-0YLTZN3E26"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const auth = firebase.auth();
  const db = firebase.firestore();
  const st = firebase.storage().ref();
</script>

<script>
  // EVENTOS DEL FORMULARIO REGISTRAR
var registrarseForm = document.querySelector('#registrarse-form');

// DETECTANDO BOTONES DE SIGN UP Y SIGN IN
var signInLink = document.getElementById('#linkSignIn');

var signUpLink = document.getElementById('#linkSignUp');

var emailGlobal = '';

registrarseForm.addEventListener('submit', (e) => {
    e.preventDefault();

    var nombres = document.querySelector('#registrarse-nombre').value;
    var email = document.querySelector('#registrarse-email').value;    
    var password = document.querySelector('#registrarse-password').value;
    
    // metodo para registrarse

    auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {

      userCredential.user.updateProfile({
        displayName : nombres
      });
      const configuration = {
        url : 'https://localhost/CL2DSWIIPabloUrbano/public/'
      };
      userCredential.user.sendEmailVerification(configuration)
      .then(result => {
        console.log('Verifique su correo :)');
      })
      .catch(error =>{    
        console.error(error);
        });
        // llamamos a los servicios de firebase para desloguearse
        firebase.auth().signOut();
        registrarseForm.reset();

        //cerramos el modal
        $('#registrarseModal').modal('hide')

        console.log('correctamente registrado')

    })
    .catch(err => {
        console.error(err.message)
        //cerramos el modal
        $('#registrarseModal').modal('hide')
    })
});

// EVENTOS DE INGRESAR
const ingresarForm = document.querySelector('#ingresar-form')

ingresarForm.addEventListener('submit', e => {
    e.preventDefault();
    const email = document.querySelector('#ingresar-email').value;
    const password = document.querySelector('#ingresar-password').value;

    auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {

        registrarseForm.reset();

        //cerramos el modal
        $('#ingresarModal').modal('hide')
        console.log('logueado correctamente por correo y contraseña')
    })
    .catch(err => {
      console.error(err.message);
    })
});


const logout = document.querySelector('#logout');

logout.addEventListener('click', e => {
    e.preventDefault();
    auth.signOut().then(() => {
        console.log('sign out');
        emailGlobal = '';
        listaTareas.innerHTML ='';
    })
});


// google Login
const  googleBtn = document.querySelector('#googleSignIn')
googleBtn.addEventListener('click', e => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
    .then(result => {
        registrarseForm.reset();

        //cerramos el modal
        $('#ingresarModal').modal('hide')
        console.log('logueado correctamente')
    })
    .catch(err =>{
        console.error(err)
    })
    //cerramos el modal
    $('#ingresarModal').modal('hide')
})

// facebook login
const facebookBtn = document.querySelector('#facebookSignIn')
facebookBtn.addEventListener('click', e => {
    e.preventDefault();
    const provider = new firebase.auth.FacebookAuthProvider();
    auth.signInWithPopup(provider)
    .then(result => {
        console.log(result);
        console.log('sign in with facebook');
    })
    .catch(err => {
        console.error(err)
    })

    //cerramos el modal
    $('#ingresarModal').modal('hide')
})


// twitter login
const twitterBtn = document.querySelector('#twitterSignIn')
twitterBtn.addEventListener('click', e => {
    e.preventDefault();
    firebase.auth().languageCode = 'es';
    auth.useDeviceLanguage();
    const provider = new firebase.auth.TwitterAuthProvider();
    provider.setCustomParameters({
      'lang': 'es'
    });
    auth.signInWithPopup(provider)
    .then(result => {
        console.log(result);
        console.log('sign in with twitter');
    })
    .catch(err => {
        console.error(err)
    })
        
    //cerramos el modal
    $('#ingresarModal').modal('hide')
})



// metodo para que se obtenga todas las tareas
const obtenerTasks = (email) => db.collection('tasks').where('email', '==', email).get();

const obtenerTask = (id) => db.collection('tasks').doc(id).get();

const cuandoObtengaTareas = (callback) => db.collection('tasks').onSnapshot(callback);

const eliminarTarea = id => db.collection('tasks').doc(id).delete();

const actualizarTarea = (id, updatedTarea) => db.collection('tasks').doc(id).update(updatedTarea);



// Tareas por usuario
const listaTareas = document.querySelector('#tasks-contenedor');

const setupTareas = data => {
    if(data.length) {
        let html = '';
        cabecera = '<h4>Mis tareas Pendientes...</h4>';
        html += cabecera;
        data.forEach(doc => {
            // obtengo los datos del documento
            const tarea = doc.data();
            tarea.id = doc.id;
            if(tarea.foto!='' && tarea.archivo!=''){
              const div = `<div class="card card-body mt-2 border-primary">
              <h3 class="h4" style="text-align:center">${tarea.titulo}</h3>
              <div style="float:left;">
                <div style="width:50%;float:left; text-align:center">
                  <p class="p">${tarea.descripcion}</p>
                </div>
                <div style="width:50%;float:right; text-align:center">
                  <img style="width: 150px; height:150px;" src="${tarea.foto}" alt="no existe"></img>
                </div>
              </div>
              <div class="text-align:center">
                <a  class="btn btn-dark" href="${tarea.archivo}">Descarga tu archivo guardado</a>  
              </div>
              <div class="row" style="text-align:center;margin-top:10px;">
                <div class="col-6">
                  <button class ="btn btn-danger btn-delete btn-block" data-id="${tarea.id}"> Eliminar </button>
                </div>
                <div class="col-6">
                  <button class ="btn btn-success btn-edit btn-block" data-id="${tarea.id}"> Modificar </button>
                </div>
              </div>
            </div>`;  
            html += div;
            }
            else if(tarea.foto != ''){
              const div = `<div class="card card-body mt-2 border-primary">
              <h3 class="h4" style="text-align:center">${tarea.titulo}</h3>
              <div style="float:left;">
                <div style="width:50%;float:left; text-align:center">
                  <p class="p">${tarea.descripcion}</p>
                </div>
                <div style="width:50%;float:right; text-align:center">
                  <img style="width: 150px; height:150px;" src="${tarea.foto}" alt="no existe"></img>
                </div>
              </div>
              <div class="row" style="text-align:center;margin-top:10px;">
                <div class="col-6">
                  <button class ="btn btn-danger btn-delete btn-block" data-id="${tarea.id}"> Eliminar </button>
                </div>
                <div class="col-6">
                  <button class ="btn btn-success btn-edit btn-block" data-id="${tarea.id}"> Modificar </button>
                </div>
              </div>
            </div>`;  
            html += div;
            }
            else if(tarea.archivo != ''){
              const div = `<div class="card card-body mt-2 border-primary">
              <h3 class="h4" style="text-align:center">${tarea.titulo}</h3>
              <div style="float:left;">
                <div style="width:100%; text-align:center">
                  <p class="p">${tarea.descripcion}</p>
                </div>
                <div style="width:100%;float:right; text-align:center">
                  <a  class="btn btn-dark" href="${tarea.archivo}">Descarga tu archivo guardado</a>
                </div>
              </div>
              <div class="row" style="text-align:center;margin-top:10px;">
                <div class="col-6">
                  <button class ="btn btn-danger btn-delete btn-block" data-id="${tarea.id}"> Eliminar </button>
                </div>
                <div class="col-6">
                  <button class ="btn btn-success btn-edit btn-block" data-id="${tarea.id}"> Modificar </button>
                </div>
              </div>
            </div>`;  
            html += div;
            }else {
              const div = `<div class="card card-body mt-2 border-primary">
              <h3 class="h4" style="text-align:center">${tarea.titulo}</h3>
              <div style="width:100%;text-align:center">
                <p class="p">${tarea.descripcion}</p>
              </div>
              <div class="row" style="text-align:center;margin-top:10px;">
              <div class="col-6">
                <button class ="btn btn-danger btn-delete btn-block" data-id="${tarea.id}"> Eliminar </button>
              </div>
              <div class="col-6">
                <button class ="btn btn-success btn-edit btn-block" data-id="${tarea.id}"> Modificar </button>
              </div>
              </div>
            </div>`;  
            html += div;
            }
        });

        listaTareas.innerHTML = html;

        //  obtenemos todos los botones delete
        const btnsdelete = document.querySelectorAll('.btn-delete');
          
        btnsdelete.forEach( btn => {
          // por cada boton agragale un evento
            btn.addEventListener('click', async (e) => {
              await eliminarTarea(e.target.dataset.id);

              obtenerTasks(emailGlobal)
              .then((snapshot) => {
                setupTareas(snapshot.docs);
              })
              .catch(err =>{
                console.error(err);
              });
            });
        });
         
         //  obtenemos todos los botones delete
       const btnsedit = document.querySelectorAll('.btn-edit');
       
       btnsedit.forEach( btn => {
         // por cada boton agragale un evento
           btn.addEventListener('click', async(e) => {
             const doc = await obtenerTask(e.target.dataset.id);                
             const task = doc.data();
             editStatus = true;
             id = doc.id;
             taskForm['task-titulo'].value = task.titulo;
             taskForm['task-descripcion'].value = task.descripcion;
             taskForm['btn-task-form'].innerText = 'Editar';
         });
       });

    }else {
        listaTareas.innerHTML= '<p class="text-center">Aun no registras una tarea</p>'
    }
}

// eventos
// listar los tareas para los usuarios autenticados
auth.onAuthStateChanged(user => {
    if(user){
        emailGlobal = user.email;
        console.log('auth: signin');
        obtenerTasks(emailGlobal)
        .then((snapshot) => {
            setupTareas(snapshot.docs);
        })
        .catch(err =>{
          console.error(err).message;
        })

    }else{
        console.log('auth: signout')
    }
});




// detecto el boton de subir tarea
const taskForm = document.getElementById("task-form");


// usamos para comprobar el edit
let editStatus = false;
let id = '';

const guardarTask = (email,titulo,descripcion, foto, archivo) =>
  db.collection('tasks').doc().set({
    email,
    titulo,
    descripcion,
    foto,
    archivo
  });

// REGISTRAR  /   EDITAR
taskForm.addEventListener('submit', async (e) => {
  // esto hace que no se refresque la pagina
  e.preventDefault();
  // detecto los datos de los id dentro del form
  if(emailGlobal === ''){
    return ; 
  }
  const email = emailGlobal;
  const titulo = taskForm['task-titulo'];
  const descripcion = taskForm['task-descripcion'];
  const photo = taskForm['task-imagen'].files[0];
  const archivo = taskForm['task-archivo'].files[0];
  if(!editStatus){
    
    if(photo != null && archivo != null){
      const namepho = new Date() + '-'+photo.name; 
      const metadataphoto = {
        contentType : photo.type
      }

      const subirfoto = st.child(namepho).put(photo, metadataphoto);
      const titulo2 = titulo.value;
      const descripcion2 = descripcion.value;
      subirfoto.then(snapshot => snapshot.ref.getDownloadURL())
      .then( urlfoto => {

        const namearc = new Date() + '-'+ archivo.name;
        const metadataarchivo = {
          contentType : archivo.type
        }
        
        const subirarchivo = st.child(namearc).put(archivo, metadataarchivo);
        subirarchivo.then(snapshot => snapshot.ref.getDownloadURL())
        .then( urlarchivo => {

          guardarTask(email, titulo2, descripcion2, urlfoto, urlarchivo);

          obtenerTasks(email)
          .then((snapshot) => {
              setupTareas(snapshot.docs);
              console.log('ejecutando obtenerTareas en onAuthStateChanged');
          })
          .catch(err =>{
            console.error(err.message);
          });
        })
        .catch(err => {
          console.error(`Error en subir archivo ${err.message}`);
        })
      })
      .catch(err => {
        console.error(`Error en subir photo ${err.message}`);
      })
    }
    else
    if(archivo != null){
      const name = new Date() + '-'+archivo.name;
      const metadata = {
        contentType : archivo.type
      }

      const titulo2 = titulo.value;
      const descripcion2 = descripcion.value;

      const subir = st.child(name).put(archivo, metadata);
      subir.then(snapshot => snapshot.ref.getDownloadURL())
      .then( url => {
        console.log(`Ruta del archivo subido : ${url}`);
        guardarTask(email, titulo2, descripcion2, '', url);

        obtenerTasks(email)
        .then((snapshot) => {
            setupTareas(snapshot.docs);
            console.log('ejecutando obtenerTareas en onAuthStateChanged');
        })
        .catch(err =>{
          console.error(err.message);
        });
      })
      .catch(err => {
        console.error(`Error en subir archivo ${err.message}`);
      })

    }else if(photo!= null){
      const name = new Date() + '-'+photo.name;
      const metadata = {
        contentType : photo.type
      }

      const titulo2 = titulo.value;
      const descripcion2 = descripcion.value;

      const subir = st.child(name).put(photo, metadata);
      subir.then(snapshot => snapshot.ref.getDownloadURL())
      .then( url => {
        console.log(`Ruta del archivo subido : ${url}`);
        guardarTask(email, titulo2, descripcion2, url, '');

        obtenerTasks(email)
        .then((snapshot) => {
            setupTareas(snapshot.docs);
            console.log('ejecutando obtenerTareas en onAuthStateChanged');
        })
        .catch(err =>{
          console.error(err.message);
        });
      })
      .catch(err => {
        console.error(`Error en subir archivo ${err.message}`);
      })
    }else{
      await guardarTask(email, titulo.value, descripcion.value, '', '');
      
    }
   
  } else {
    await actualizarTarea(id, {
        email: email,
       titulo: titulo.value,
       descripcion: descripcion.value,
    });

    editStatus = false;
    id = '';
    taskForm['btn-task-form'].innerText = 'Guardar';

  }

  // limpiamos los campos
  taskForm.reset();

  // el cursor se pone encima del titulo
  titulo.focus();

  obtenerTasks(email)
  .then((snapshot) => {
      setupTareas(snapshot.docs);
      console.log('ejecutando obtenerTareas en onAuthStateChanged');
  })
  .catch(err =>{
    console.error(err.message);
  });
});
</script>

</body>

</html>